      SUBROUTINE XCENERGY_DENSITY(CI,PSIR,DLINE,IX,IY,IZ,G1,
     &	   SITAB,NMAX,
     &	   NMESHX,NHG,RHO,XCHOLE,ALAT,OMEGA,NMRKS,NDET,NEVAL,NEL)
C..   Compute the XC energy density at IX,IY,IZ. Returned in XCEPS
C..   Needs the density RHO
      IMPLICIT REAL*8 (A-H,O-Z)
      DIMENSION CI(NDET,NEVAL)
      DIMENSION NMRKS(NEL,*)
      DIMENSION PSIR(-NMESHX:NMESHX),DLINE(NMESHX)
      DIMENSION RHO(NMESHX,NMESHX,NMESHX)
      DIMENSION XCHOLE(NMESHX,NMESHX,NMESHX)
      DIMENSION SITAB(NMESHX,NMAX),ALAT(3)
      INTEGER G1(5,NHG)
      REAL*8 KF
      CALL GEN_XCHOLE(CI,PSIR,IX,IY,IZ,G1,SITAB,NMAX,
     &     NMESHX,NHG,0,1,1,RHO,.TRUE.,XCHOLE,SPAC,ALAT,OMEGA,
     &	   NMRKS,NDET,NEVAL,NEL) 
C..   
      THIRD=1.D0/3.D0
      PI=ACOS(-1.D0)
      PI2=PI*PI
      XCEPS=0.D0
      XSPACING=ALAT(1)/DFLOAT(NMESHX)
      YSPACING=ALAT(2)/DFLOAT(NMESHX)
      ZSPACING=ALAT(3)/DFLOAT(NMESHX)
      DO K=1,NMESHX
         DZ=((K-IZ)*ZSPACING)**2
         DO J=1,NMESHX
            DY=((J-IY)*YSPACING)**2
            DO I=1,NMESHX
               DX=((I-IX)*XSPACING)**2
               D=SQRT(DX+DY+DZ)
               IF(D.EQ.0.D0) GOTO 100
               XCEPS=XCEPS+XCHOLE(I,J,K)/D
 100           CONTINUE
            ENDDO
         ENDDO
      ENDDO
      XCEPS=XCEPS*OMEGA/DFLOAT(NMESHX*NMESHX*NMESHX)/2.D0
C..This is the Dirac exchange term     
      KF=(3.D0*PI2*RHO(IX,IY,IZ))**THIRD
      XCLDA=-3.D0*KF/(4.D0*PI)
C..Need to add in the correlation part
C..so we send in RHO(IX,IY,IZ)
      RH=RHO(IX,IY,IZ)
      CALL XC(0,1,RH,EX,EC,VX,VC)
      XCLDA=XCLDA+EC
C      WRITE(11,'(3(I3,1X),F14.9,1X,F14.9)')
C     &		IX,IY,IZ,XCEPS,XCLDA
      WRITE(11,'((I3,1X),F14.9,1X,F14.9)')
     &		IZ,XCEPS,XCLDA
      RETURN
      END
